version: 2.1

workflows:
  gate-and-deploy:
    jobs:
      - test
      - decide-next-step:
          requires:
            - test
      - wait-for-approval:
          type: approval
          requires:
            - decide-next-step
          filters:
            branches:
              only: main
      - deploy:
          requires:
            - decide-next-step
            - wait-for-approval

jobs:
  test:
    docker:
      - image: cimg/node:20.5
    steps:
      - checkout
      - run: echo "‚úÖ Tests run on all PRs"

  decide-next-step:
    docker:
      - image: cimg/base:stable
    steps:
      - run:
          name: Check for forked PR
          command: |
            if [ "$CIRCLE_PR_USERNAME" != "$CIRCLE_PROJECT_USERNAME" ]; then
              echo "This is a forked PR. Requiring approval."
              echo "export NEEDS_APPROVAL=true" >> needs_approval.env
            else
              echo "This is a collaborator PR. Proceeding without approval."
              echo "export NEEDS_APPROVAL=false" >> needs_approval.env
            fi
      - persist_to_workspace:
          root: .
          paths:
            - needs_approval.env

  deploy:
    docker:
      - image: cimg/base:stable
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Use secrets
          command: |
            source needs_approval.env
            if [ "$NEEDS_APPROVAL" = "true" ]; then
              echo "‚ùå Should not be here without approval."
              exit 1
            fi
            echo "üîê Deploying with secrets: $MY_SECRET"
    environment:
      MY_SECRET: "${MY_SECRET}"
